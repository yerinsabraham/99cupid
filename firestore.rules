rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUser(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUser(request.auth.uid).isAdmin == true;
    }
    
    function isChatParticipant(chatId) {
      let chatDoc = get(/databases/$(database)/documents/chats/$(chatId)).data;
      return isAuthenticated() && (
        chatDoc.user1Id == request.auth.uid || 
        chatDoc.user2Id == request.auth.uid
      );
    }
    
    // Users Collection - Strict access control
    match /users/{userId} {
      // Allow authenticated users to read any user profile (needed for matching)
      // Admins can read all users
      allow read: if isAuthenticated();
      
      // List/query access (needed for matching algorithm and admin dashboard)
      allow list: if isAuthenticated();
      
      // Only allow users to create their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Allow users to update their own profile OR admins can update any profile
      // Allow soft delete (accountStatus='deleted') for own account
      allow update: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin() ||
        (isOwner(userId) && request.resource.data.accountStatus == 'deleted')
      );
      
      // Hard delete only via admin OR user can delete own account
      allow delete: if isAuthenticated() && (isAdmin() || isOwner(userId));
    }
    
    // Matches Collection - Only matched users
    match /matches/{matchId} {
      allow read: if isAuthenticated() && 
                  (resource.data.user1Id == request.auth.uid || 
                   resource.data.user2Id == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                    (resource.data.user1Id == request.auth.uid || 
                     resource.data.user2Id == request.auth.uid);
      // Allow deletion by either participant
      allow delete: if isAuthenticated() && 
                    (resource.data.user1Id == request.auth.uid || 
                     resource.data.user2Id == request.auth.uid);
    }
    
    // Chats Collection - Only participants can read
    match /chats/{chatId} {
      allow read: if isChatParticipant(chatId);
      allow create: if isAuthenticated();
      allow update: if isChatParticipant(chatId);
      // Allow participants to delete chats (needed for account deletion)
      allow delete: if isChatParticipant(chatId);
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isChatParticipant(chatId);
        allow create: if isChatParticipant(chatId) && 
                      request.resource.data.senderId == request.auth.uid &&
                      request.resource.data.timestamp == request.time;
        allow update: if isChatParticipant(chatId) && 
                      resource.data.senderId == request.auth.uid;
        // Allow sender or chat participants to delete messages
        allow delete: if isChatParticipant(chatId);
      }
    }
    
    // Verification Requests Collection
    match /verifications/{verificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && (
        (request.resource.data.userId == request.auth.uid && request.resource.data.status == 'pending') ||
        isAdmin()
      );
      allow update: if isAdmin(); // Only admins can approve/reject
      // Allow deletion for account removal, but maintain audit trail in normal operations
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Reports Collection - Admin only
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      // Allow deletion by report creator (needed for account deletion)
      allow delete: if isAuthenticated() && resource.data.reporterId == request.auth.uid;
    }
    
    // Likes Collection
    match /likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.fromUserId == request.auth.uid;
      // Allow deletion by the user who created the like
      allow delete: if isAuthenticated() && resource.data.fromUserId == request.auth.uid;
      allow update: if false;
    }
    
    // Swipes Collection
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      // Allow deletion by swipe owner (needed for account deletion)
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Early Users Collection - Landing page signups (legacy)
    match /earlyUsers/{docId} {
      allow read: if true;
      allow create: if true;
      allow update: if false;
      allow delete: if false;
    }
    
    // Landing Signups Collection - New landing page signups
    match /landing_signups/{docId} {
      allow read: if true;
      allow create: if true;
      allow update: if false;
      allow delete: if false;
    }
    
    // Block users collection (if needed)
    match /blocks/{blockId} {
      allow read: if isAuthenticated() && (
        resource.data.blockerId == request.auth.uid ||
        resource.data.blockedId == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.blockerId == request.auth.uid;
      // Allow deletion by blocker or blocked user (needed for account deletion)
      allow delete: if isAuthenticated() && (
        resource.data.blockerId == request.auth.uid ||
        resource.data.blockedId == request.auth.uid
      );
      allow update: if false;
    }
    
    // Analytics Events Collection - Write-only for users, read for admins
    match /analytics_events/{eventId} {
      allow read: if isAdmin();
      allow create: if true; // Allow all to write events (including anonymous)
      allow update: if false;
      allow delete: if false;
    }
    
    // Analytics Aggregates Collection - Admin only
    match /analytics_aggregates/{aggregateId} {
      allow read: if isAdmin();
      allow write: if false; // System writes only
    }
    
    // Subscriptions Collection
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Transactions Collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // Catch-all - deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
